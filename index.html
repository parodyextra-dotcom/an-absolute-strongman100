<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ </title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100%; width: 100%; }
        .user-marker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        .online-indicator {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="startScreen" class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 mx-4 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ </h1>
                <p class="text-gray-500 mt-2">ì¹œêµ¬ë“¤ê³¼ ìœ„ì¹˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•˜ì„¸ìš”</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„</label>
                    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë°© ì½”ë“œ</label>
                    <input type="text" id="roomCode" placeholder="ë°© ì½”ë“œ (ì—†ìœ¼ë©´ ìë™ ìƒì„±)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition">
                </div>
                
                <button onclick="startApp()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition transform hover:scale-105">
                    ì‹œì‘í•˜ê¸°
                </button>
            </div>
            
            <p class="text-xs text-gray-400 text-center mt-4">
                ğŸ’¡ ê°™ì€ ë°© ì½”ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ìœ„ì¹˜ê°€ ê³µìœ ë©ë‹ˆë‹¤<br>
                (ì—¬ëŸ¬ íƒ­ì„ ì—´ì–´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!)
            </p>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div id="mainApp" class="hidden h-screen flex flex-col">
        <!-- í—¤ë” -->
        <header class="bg-white shadow-md px-4 py-3 flex items-center justify-between z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800">ìœ„ì¹˜ ê³µìœ </h1>
                    <p class="text-xs text-gray-500">ë°©: <span id="displayRoomCode" class="font-mono text-indigo-600"></span></p>
                </div>
            </div>
            <button onclick="copyRoomCode()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-200 transition">
                ğŸ“‹ ì½”ë“œ ë³µì‚¬
            </button>
        </header>

        <!-- ì§€ë„ -->
        <div class="flex-1 relative">
            <div id="map"></div>
            
            <!-- ë‚´ ìœ„ì¹˜ ë²„íŠ¼ -->
            <button onclick="centerOnMe()" 
                    class="absolute bottom-24 right-4 w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition z-[1000]">
                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
        </div>

        <!-- ì‚¬ìš©ì ëª©ë¡ íŒ¨ë„ -->
        <div class="bg-white border-t border-gray-200 p-4 max-h-48 overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold text-gray-800">ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ì</h2>
                <span id="userCount" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-medium">0ëª…</span>
            </div>
            <div id="userList" class="space-y-2">
                <!-- ì‚¬ìš©ì ëª©ë¡ -->
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] opacity-0 transition-opacity duration-300 pointer-events-none">
        <span id="toastMessage"></span>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let myMarker;
        let markers = {};
        let myId;
        let myNickname;
        let roomCode;
        let channel;
        let watchId;

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colors = [
            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', 
            '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
        ];

        // ëœë¤ ID ìƒì„±
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // ëœë¤ ë°© ì½”ë“œ ìƒì„±
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // ìƒ‰ìƒ í• ë‹¹
        function getColorForUser(id) {
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // ë°© ì½”ë“œ ë³µì‚¬
        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode).then(() => {
                showToast('ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // ì•± ì‹œì‘
        function startApp() {
            myNickname = document.getElementById('nickname').value.trim() || 'ìµëª…' + Math.floor(Math.random() * 1000);
            roomCode = document.getElementById('roomCode').value.trim().toUpperCase() || generateRoomCode();
            myId = generateId();

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = roomCode;

            initMap();
            initChannel();
            startLocationTracking();
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            map = L.map('map').setView([37.5665, 126.9780], 15); // ì„œìš¸ ê¸°ë³¸ ìœ„ì¹˜

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        // BroadcastChannel ì´ˆê¸°í™” (ê°™ì€ ë¸Œë¼ìš°ì € íƒ­ ê°„ í†µì‹ )
        function initChannel() {
            channel = new BroadcastChannel('location-share-' + roomCode);

            channel.onmessage = (event) => {
                const data = event.data;
                
                if (data.type === 'location') {
                    updateUserLocation(data);
                } else if (data.type === 'join') {
                    showToast(`${data.nickname}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤!`);
                    // ë‚´ ìœ„ì¹˜ ë‹¤ì‹œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
                    if (myMarker) {
                        const pos = myMarker.getLatLng();
                        broadcastLocation(pos.lat, pos.lng);
                    }
                } else if (data.type === 'leave') {
                    removeUser(data.id);
                    showToast(`${data.nickname}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
                }
            };

            // ì…ì¥ ì•Œë¦¼
            channel.postMessage({
                type: 'join',
                id: myId,
                nickname: myNickname
            });

            // í˜ì´ì§€ ì¢…ë£Œ ì‹œ í‡´ì¥ ì•Œë¦¼
            window.addEventListener('beforeunload', () => {
                channel.postMessage({
                    type: 'leave',
                    id: myId,
                    nickname: myNickname
                });
            });
        }

        // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    updateMyLocation(latitude, longitude);
                    map.setView([latitude, longitude], 16);
                },
                (error) => {
                    console.error('ìœ„ì¹˜ ì˜¤ë¥˜:', error);
                    showToast('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                },
                options
            );

            // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì 
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    updateMyLocation(latitude, longitude);
                },
                (error) => {
                    console.error('ìœ„ì¹˜ ì¶”ì  ì˜¤ë¥˜:', error);
                },
                options
            );
        }

        // ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateMyLocation(lat, lng) {
            const color = getColorForUser(myId);

            if (!myMarker) {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div class="relative">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center pulse" style="background: ${color}; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                                <span class="text-white font-bold text-sm">${myNickname.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 bg-white px-2 py-0.5 rounded-full text-xs font-medium shadow whitespace-nowrap">
                                ${myNickname} (ë‚˜)
                            </div>
                        </div>
                    `,
                    iconSize: [48, 60],
                    iconAnchor: [24, 48]
                });

                myMarker = L.marker([lat, lng], { icon }).addTo(map);
            } else {
                myMarker.setLatLng([lat, lng]);
            }

            broadcastLocation(lat, lng);
            updateUserList();
        }

        // ìœ„ì¹˜ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        function broadcastLocation(lat, lng) {
            channel.postMessage({
                type: 'location',
                id: myId,
                nickname: myNickname,
                lat,
                lng,
                timestamp: Date.now()
            });
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ì ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateUserLocation(data) {
            if (data.id === myId) return;

            const color = getColorForUser(data.id);

            if (!markers[data.id]) {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div class="relative">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: ${color}; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                                <span class="text-white font-bold text-sm">${data.nickname.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 bg-white px-2 py-0.5 rounded-full text-xs font-medium shadow whitespace-nowrap">
                                ${data.nickname}
                            </div>
                        </div>
                    `,
                    iconSize: [40, 52],
                    iconAnchor: [20, 40]
                });

                markers[data.id] = {
                    marker: L.marker([data.lat, data.lng], { icon }).addTo(map),
                    nickname: data.nickname,
                    color,
                    timestamp: data.timestamp
                };

                showToast(`${data.nickname}ë‹˜ì˜ ìœ„ì¹˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.`);
            } else {
                markers[data.id].marker.setLatLng([data.lat, data.lng]);
                markers[data.id].timestamp = data.timestamp;
            }

            updateUserList();
        }

        // ì‚¬ìš©ì ì œê±°
        function removeUser(id) {
            if (markers[id]) {
                map.removeLayer(markers[id].marker);
                delete markers[id];
                updateUserList();
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateUserList() {
            const userList = document.getElementById('userList');
            const myColor = getColorForUser(myId);
            
            let html = `
                <div class="flex items-center justify-between p-2 bg-indigo-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style="background: ${myColor}">
                            ${myNickname.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${myNickname} <span class="text-indigo-600 text-xs">(ë‚˜)</span></p>
                            <p class="text-xs text-gray-500">í˜„ì¬ ìœ„ì¹˜ ê³µìœ  ì¤‘</p>
                        </div>
                    </div>
                    <div class="online-indicator"></div>
                </div>
            `;

            for (const id in markers) {
                const user = markers[id];
                const timeDiff = Math.floor((Date.now() - user.timestamp) / 1000);
                const timeText = timeDiff < 60 ? `${timeDiff}ì´ˆ ì „` : `${Math.floor(timeDiff / 60)}ë¶„ ì „`;
                
                html += `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" onclick="focusUser('${id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style="background: ${user.color}">
                                ${user.nickname.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${user.nickname}</p>
                                <p class="text-xs text-gray-500">ì—…ë°ì´íŠ¸: ${timeText}</p>
                            </div>
                        </div>
                        <div class="online-indicator"></div>
                    </div>
                `;
            }

            userList.innerHTML = html;
            document.getElementById('userCount').textContent = `${Object.keys(markers).length + 1}ëª…`;
        }

        // íŠ¹ì • ì‚¬ìš©ìì—ê²Œ í¬ì»¤ìŠ¤
        function focusUser(id) {
            if (markers[id]) {
                const pos = markers[id].marker.getLatLng();
                map.setView(pos, 17);
            }
        }

        // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
        function centerOnMe() {
            if (myMarker) {
                map.setView(myMarker.getLatLng(), 17);
            }
        }

        // ì˜¤ë˜ëœ ì‚¬ìš©ì ì œê±° (30ì´ˆ ì´ìƒ ì—…ë°ì´íŠ¸ ì—†ìŒ)
        setInterval(() => {
            const now = Date.now();
            for (const id in markers) {
                if (now - markers[id].timestamp > 30000) {
                    removeUser(id);
                }
            }
        }, 5000);
    </script>
</body>
</html>
